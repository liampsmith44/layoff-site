{% extends "base.html" %}
{% block title %}Bookmaker Calculator %{% endblock %}

{% block head_extra %}
<style>
  .bm-card{ background:#fff; border:2px solid #111827; border-radius:12px; box-shadow: var(--shadow); }
  .bm-head{ display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
  .bm-desc{ color:var(--muted); font-size:14px; }
  .bm-grid-head, .bm-row{
    display:grid; grid-template-columns: 56px 1.1fr 1.2fr 120px;
    gap:12px; align-items:center;
  }
  .bm-grid-head{ background:#111827; color:#fff; padding:10px 12px; border-radius:12px; font-weight:600; }
  .bm-row{ padding:10px 0; }
  .bm-actions{ display:flex; gap:8px; }
  .pill{ display:inline-flex; align-items:center; padding:8px 12px; border-radius:12px; color:#fff; font-weight:700; }
  .pill.dark{ background:#111827; }
  .prob-badge{ background: rgba(22,163,74,.12); color:#16a34a; font-weight:700; border-radius:999px; padding:6px 10px; font-size:13px; }
  .btn-mini{ border:0; padding:8px 10px; border-radius:10px; background:#f3f4f6; cursor:pointer }
  .btn-mini:hover{ filter:brightness(1.05) }
</style>
{% endblock %}

{% block content %}
<div class="wrap" style="max-width:980px; margin:24px auto;">
  <div class="card bm-card">
    <div class="bm-head">
      <h2 style="margin:0">Bookmakers Percentage Calculator</h2>
      <div class="bm-desc">
        Enter decimal odds for outcomes in a market. We’ll convert to implied probabilities and show the total
        <strong>book percentage</strong>. In a perfectly “fair” market, the total would be 100% but we understand that Bookies need to turn a profit.
      </div>
    </div>

    <div class="bm-grid-head">
      <div>#</div>
      <div>Selection</div>
      <div>Odds (decimal)</div>
      <div>Probability</div>
    </div>

    <div id="rows"></div>

    <div style="display:flex; gap:14px; align-items:center; margin-top:14px;">
      <div class="pill dark">
        <div style="opacity:.8; font-weight:600; margin-right:8px;">Book %</div>
        <span id="bookTotal">0.00%</span>
      </div>

      <div style="margin-left:auto; display:flex; gap:10px;">
        <button class="btn btn-success" id="addRowBtn" type="button">Add Row</button>
        <button class="btn btn-danger" id="resetBtn" type="button">Reset</button>
      </div>
    </div>

    <p style="margin-top:12px; color:var(--muted); font-size:13px;">
      <strong>Formula:</strong> Probability (%) = (1 / odds) × 100. Book % = sum of probabilities.
    </p>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const rowsEl = document.getElementById('rows');
  const bookEl = document.getElementById('bookTotal');
  const addRowBtn = document.getElementById('addRowBtn');
  const resetBtn = document.getElementById('resetBtn');

  let rowCount = 0;

  function fmtPct(n){ return isFinite(n) ? n.toFixed(2) + '%' : '0.00%'; }
  function clamp2(x){ return Math.max(0, x); }

  function makeRow(index){
    const wrapper = document.createElement('div');
    wrapper.className = 'bm-row';
    wrapper.dataset.index = index;

    wrapper.innerHTML = `
      <div>${index}</div>

      <div>
        <input class="input" type="text" placeholder="Name" aria-label="Selection name">
      </div>

      <div>
        <div style="display:flex; gap:8px; align-items:center;">
          <button type="button" class="btn-mini" data-dec>-</button>
          <input class="input" type="number" step="0.01" inputmode="decimal" placeholder="0.00" aria-label="Odds">
          <button type="button" class="btn-mini" data-inc>+</button>
          <button type="button" class="btn-mini" data-del title="Remove row">×</button>
        </div>
      </div>

      <div><span class="prob-badge" data-prob>0.00%</span></div>
    `;

    const oddsInput = wrapper.querySelector('input[type="number"]');
    const decBtn = wrapper.querySelector('[data-dec]');
    const incBtn = wrapper.querySelector('[data-inc]');
    const delBtn = wrapper.querySelector('[data-del]');
    const probOut = wrapper.querySelector('[data-prob]');

    function recompute(){
      const v = parseFloat(oddsInput.value);
      const p = (v > 0) ? (100 / v) : 0;
      probOut.textContent = fmtPct(p);
      updateBook();
    }

    oddsInput.addEventListener('input', recompute);
    incBtn.addEventListener('click', () => {
      const v = parseFloat(oddsInput.value) || 0;
      oddsInput.value = (v + 0.01).toFixed(2);
      recompute();
    });
    decBtn.addEventListener('click', () => {
      const v = parseFloat(oddsInput.value) || 0;
      const next = Math.max(0, v - 0.01);
      oddsInput.value = next > 0 ? next.toFixed(2) : '';
      recompute();
    });
    delBtn.addEventListener('click', () => {
      rowsEl.removeChild(wrapper);
      renumber();
      updateBook();
    });

    rowsEl.appendChild(wrapper);
  }

  function renumber(){
    const rows = [...rowsEl.querySelectorAll('.bm-row')];
    rows.forEach((r, i) => {
      r.dataset.index = i + 1;
      r.querySelector('div:first-child').textContent = i + 1;
    });
    rowCount = rows.length;
  }

  function updateBook(){
    let total = 0;
    rowsEl.querySelectorAll('.bm-row').forEach(row => {
      const v = parseFloat(row.querySelector('input[type="number"]').value);
      if (v > 0) total += 100 / v;
    });
    bookEl.textContent = fmtPct(total);
  }

  function addRow(){
    rowCount += 1;
    makeRow(rowCount);
  }

  function reset(){
    rowsEl.innerHTML = '';
    rowCount = 0;
    for (let i = 0; i < 7; i++) addRow(); // 7 rows on load/reset
    updateBook();
  }

  addRowBtn.addEventListener('click', addRow);
  resetBtn.addEventListener('click', reset);

  // init: 7 rows, all blank placeholders
  reset();
</script>
{% endblock %}
