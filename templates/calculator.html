{% extends "base.html" %}

{% block title %}Layoff Calculator{% endblock %}

{% block head_extra %}
<style>
  :root{
    --bg: #e9eef5;
    --card: #ffffff;
    --text: #1e1f24;
    --muted: #6b7280;
    --primary: #2563eb;
    --primary-600:#1d4ed8;
    --primary-700:#1e40af;
    --accent: #d4af37;
    --success:#16a34a;
    --danger:#dc2626;
    --warning:#f59e0b;
    --border:#e5e7eb;
    --shadow: 0 8px 20px rgba(15, 23, 42, .06);
    --radius: 14px;
    --gap: 14px;
  }

  .container{
    max-width: 980px;
    margin: 24px auto;
    padding: 0 16px;
  }

  .card{
    border-radius: 10px;
    box-shadow: 0 6px 16px rgba(0, 0, 0, .05);
    padding: 20px;
    margin-bottom: 20px;
  }
  .card-live{
    background:#fffdf5;
    border: 2px solid #111827;
  }
  .card-layoff{
    background:#f3f7ff;
    border: 2px solid #111827;
  }
  .card-output{
    background:#f3fff3;
    border: 2px solid #111827;
  }

  .card-header{
    display:flex; align-items:center; gap:10px; margin-bottom: 14px;
  }
  .card-title{ font-weight:700; font-size: 20px; }
  .card-sub{ color:var(--muted); font-size: 14px; }

  .summary-bar{
    display:grid;
    grid-template-columns: repeat(3, minmax(0,1fr));
    gap: 10px;
    padding: 10px 12px;
    background:#111827;
    color:#fff;
    border-radius: var(--radius);
    margin-bottom: 12px;
    font-weight:600;
  }

  .bet-section-header{
    display:grid;
    grid-template-columns: 1.1fr 1fr 1fr 0.8fr;
    gap:var(--gap);
    align-items:center;
    margin: 6px 0 10px;
    padding:10px 12px;
    color:#fff;
    background:#111827;
    border-radius:var(--radius);
    font-size:14px;
  }
  .bet-section{
    display:grid;
    grid-template-columns: 1.1fr 1fr 1fr 0.8fr;
    gap:var(--gap);
    align-items:end;
    margin-bottom: 10px;
  }

  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  .input{
    width:100%;
    border:1px solid var(--border);
    border-radius: 12px;
    padding: 11px 12px;
    background:#fff;
    color:var(--text);
    transition: border-color .15s, box-shadow .15s, transform .03s ease;
  }
  .input:focus{
    outline:none;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(37,99,235,.15);
  }
  .input:active{ transform: translateY(0.5px); }

  .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px; }
  .btn{
    border:0; border-radius:12px;
    padding: 12px 14px; font-weight:600;
    cursor:pointer; transition: filter .15s, transform .03s ease;
  }
  .btn-primary{ background: var(--primary); color:#fff; }
  .btn-primary:hover{ filter: brightness(1.05); }
  .btn-primary:active{ transform: translateY(0.5px); }
  .btn-secondary{ background:#4b5563; color:#fff; }
  .btn-ghost{ background:#f3f4f6; color:#111827; }
  .btn:disabled{ opacity:.6; cursor:not-allowed; }

  .badge{
    display:inline-flex; align-items:center; gap:8px;
    padding: 6px 10px; border-radius:999px; font-weight:600; font-size: 13px;
  }
  .badge.success{ background: rgba(22,163,74,.1); color: #16a34a; }
  .badge.danger{  background: rgba(220,38,38,.10); color: #dc2626; }
  .badge.warning{ background: rgba(245,158,11,.12); color: #f59e0b; }

  .output{
    background: #f0fdf4;
    border:1px solid #dcfce7;
    border-radius: var(--radius);
    padding: 14px;
    line-height:1.6;
    min-height: 44px;
  }
  .profit { color: #16a34a; font-weight:600; }
  .loss   { color: #dc2626; font-weight:600; }
  .error  { color: #dc2626; font-size:12px; margin-top:6px }

  @media (max-width: 900px){
    .bet-section,.bet-section-header{ grid-template-columns: 1fr 1fr; }
    .summary-bar{ grid-template-columns: 1fr; }
  }
  @media (max-width: 540px){
    .actions{ position: sticky; bottom: 12px; z-index: 10 }
    .btn-primary{ width:100% }
  }
</style>
{% endblock %}

{% block content %}
<div class="container">

  <!-- Live Bets -->
  <div class="card card-live">
    <div class="card-header">
      <div class="card-title">Live Bets</div>
      <div class="card-sub">Enter your current positions</div>
    </div>

    <div class="summary-bar" id="running-total">
      <div>TOTAL LIVE BETS:</div>
      <div>TOTAL STAKE: $0.00</div>
      <div>MAX PROFIT: $0.00</div>
    </div>

    <div class="bet-section-header">
      <div><strong>Reference Name</strong></div>
      <div><strong>Bet Stake ($)</strong></div>
      <div><strong>Bet Odds ($)</strong></div>
      <div><strong>Collect</strong></div>
    </div>

    <div id="live-bets-container">
      <div class="bet-section">
        <div>
          <input class="input" type="text" id="bet1Name-1" placeholder="Enter bet reference name"
                 oninput="updateRunningTotal()" />
        </div>
        <div>
          <input class="input" type="number" inputmode="decimal" id="bet1Amount-1" placeholder="Enter your live bet amount"
                 oninput="validateInput(this,'number'); updateRunningTotal(); updateCollect(1);" />
          <div id="error-bet1Amount-1" class="error"></div>
        </div>
        <div>
          <input class="input" type="number" inputmode="decimal" id="odds1-1" step="0.01" placeholder="Enter the odds"
                 oninput="validateInput(this,'decimal'); updateRunningTotal(); updateCollect(1);" />
          <div id="error-odds1-1" class="error"></div>
        </div>
        <div>
          <span class="badge warning" id="collect1-1">$0.00</span>
        </div>
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-ghost" onclick="addLiveBet()">Add Another Live Bet</button>
    </div>
  </div>

  <!-- Layoff Bets -->
  <div class="card card-layoff">
    <div class="card-header">
      <div class="card-title">Layoff Bets</div>
      <div class="card-sub">Target profit per outcome</div>
    </div>

    <div class="bet-section-header">
      <div><strong>Reference Name</strong></div>
      <div><strong>Layoff Bet Odds ($)</strong></div>
      <div><strong>Set amount to profit ($)</strong></div>
      <div></div>
    </div>

    <div id="layoff-bets-container">
      <div class="bet-section">
        <div>
          <input class="input" type="text" id="bet2Name-1" placeholder="Enter bet reference name" />
        </div>
        <div>
          <input class="input" type="number" inputmode="decimal" id="odds2-1" step="0.01" placeholder="Enter the odds"
                 oninput="validateInput(this,'decimal')" />
          <div id="error-odds2-1" class="error"></div>
        </div>
        <div>
          <input class="input" type="number" inputmode="decimal" id="setAmount-1" placeholder="Enter profit amount"
                 oninput="validateInput(this,'number')" />
          <div id="error-setAmount-1" class="error"></div>
        </div>
        <div></div>
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-ghost"     onclick="addLayoffBet()">Add Another Layoff Bet</button>
      <button class="btn btn-secondary" onclick="clearAllFields()">Clear All</button>
      <button class="btn btn-primary"   id="calcBtn" onclick="calculateLayoff()">Calculate Layoff Bet</button>
    </div>

    <p style="font-size:12px; text-align:center; margin:6px 0 0 0;">www.layoff.com.au</p>
  </div>

  <!-- Output -->
  <div class="card card-output">
    <div class="output" id="output" aria-live="polite"></div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  let liveBetCount = 1;
  let layoffBetCount = 1;

  function validateInput(input, type) {
    const value = input.value.trim();
    const regex = /^[0-9]+(?:\.[0-9]+)?$/; // allow integers or decimals
    const errId = `error-${input.id}`;
    const errorDiv = document.getElementById(errId);
    if (!errorDiv) return;
    if (value !== '' && !regex.test(value)) errorDiv.textContent = 'Numbers only';
    else errorDiv.textContent = '';
  }

  function money(x){ return '$' + Number(x).toFixed(2); }

  function updateCollect(row) {
    const stake = parseFloat(document.getElementById(`bet1Amount-${row}`)?.value) || 0;
    const odds  = parseFloat(document.getElementById(`odds1-${row}`)?.value) || 0;
    const collect = isFinite(stake * odds) ? stake * odds : 0;
    const cell = document.getElementById(`collect1-${row}`);
    if (cell) cell.textContent = money(collect);
  }

  function updateRunningTotal() {
    let totalLiveStake = 0;
    let maxCollect = 0;

    for (let i = 1; i <= liveBetCount; i++) {
      const stake = parseFloat(document.getElementById(`bet1Amount-${i}`)?.value) || 0;
      const odds  = parseFloat(document.getElementById(`odds1-${i}`)?.value) || 0;
      const collectDisplay = document.getElementById(`collect1-${i}`);

      if (stake > 0 && odds > 0) {
        totalLiveStake += stake;
        const collectAmount = stake * odds;
        if (collectAmount > maxCollect) maxCollect = collectAmount;
        if (collectDisplay) collectDisplay.textContent = money(collectAmount);
      } else if (collectDisplay) {
        collectDisplay.textContent = money(0);
      }
    }

    const maxProfit = Math.max(0, maxCollect - totalLiveStake);
    const run = document.getElementById('running-total');
    run.innerHTML = `
      <div>TOTAL LIVE BETS: ${liveBetCount}</div>
      <div>TOTAL STAKE: ${money(totalLiveStake)}</div>
      <div>MAX PROFIT: ${money(maxProfit)}</div>
    `;
  }

  function addLiveBet() {
    liveBetCount++;
    const container = document.getElementById('live-bets-container');
    const betSection = document.createElement('div');
    betSection.classList.add('bet-section');

    betSection.innerHTML = `
      <div>
        <input class="input" type="text" id="bet1Name-${liveBetCount}" placeholder="Enter reference name"
               oninput="updateRunningTotal()" />
      </div>
      <div>
        <input class="input" type="number" inputmode="decimal" id="bet1Amount-${liveBetCount}" placeholder="Enter your live bet amount"
               oninput="validateInput(this,'number'); updateRunningTotal(); updateCollect(${liveBetCount});" />
        <div id="error-bet1Amount-${liveBetCount}" class="error"></div>
      </div>
      <div>
        <input class="input" type="number" inputmode="decimal" id="odds1-${liveBetCount}" step="0.01" placeholder="Enter the odds"
               oninput="validateInput(this,'decimal'); updateRunningTotal(); updateCollect(${liveBetCount});" />
        <div id="error-odds1-${liveBetCount}" class="error"></div>
      </div>
      <div>
        <span class="badge warning" id="collect1-${liveBetCount}">$0.00</span>
      </div>
    `;
    container.appendChild(betSection);
  }

  function addLayoffBet() {
    layoffBetCount++;
    const container = document.getElementById('layoff-bets-container');
    const betSection = document.createElement('div');
    betSection.classList.add('bet-section');

    betSection.innerHTML = `
      <div>
        <input class="input" type="text" id="bet2Name-${layoffBetCount}" placeholder="Enter reference name" />
      </div>
      <div>
        <input class="input" type="number" inputmode="decimal" id="odds2-${layoffBetCount}" step="0.01" placeholder="Enter the odds"
               oninput="validateInput(this,'decimal')" />
        <div id="error-odds2-${layoffBetCount}" class="error"></div>
      </div>
      <div>
        <input class="input" type="number" inputmode="decimal" id="setAmount-${layoffBetCount}" placeholder="Enter profit amount"
               oninput="validateInput(this,'number')" />
        <div id="error-setAmount-${layoffBetCount}" class="error"></div>
      </div>
      <div></div>
    `;
    container.appendChild(betSection);
  }

  function solveLinearSystem(A, b) {
    const n = A.length;
    A = A.map(row => row.slice());
    b = b.slice();
    const EPS = 1e-9;

    for (let i = 0; i < n; i++) {
      let piv = i;
      for (let r = i + 1; r < n; r++) {
        if (Math.abs(A[r][i]) > Math.abs(A[piv][i])) piv = r;
      }
      if (Math.abs(A[piv][i]) < EPS) throw new Error('System is singular or ill-conditioned.');
      if (piv !== i) {
        [A[i], A[piv]] = [A[piv], A[i]];
        [b[i], b[piv]] = [b[piv], b[i]];
      }
      for (let r = i + 1; r < n; r++) {
        const f = A[r][i] / A[i][i];
        for (let c = i; c < n; c++) A[r][c] -= f * A[i][c];
        b[r] -= f * b[i];
      }
    }

    const x = new Array(n).fill(0);
    for (let i = n - 1; i >= 0; i--) {
      let s = b[i];
      for (let c = i + 1; c < n; c++) s -= A[i][c] * x[c];
      x[i] = s / A[i][i];
    }
    return x;
  }

  function calculateLayoff() {
    const btn = document.getElementById('calcBtn');
    btn.disabled = true; btn.textContent = 'Calculatingâ€¦';

    const out = document.getElementById('output');
    out.innerHTML = '';

    // 1) Live bets
    let live = [];
    let totalLiveStake = 0;

    for (let i = 1; i <= liveBetCount; i++) {
      const name  = (document.getElementById(`bet1Name-${i}`)?.value || `Live Bet ${i}`).trim();
      const stake = parseFloat(document.getElementById(`bet1Amount-${i}`)?.value);
      const odds  = parseFloat(document.getElementById(`odds1-${i}`)?.value);
      if (!isNaN(stake) && !isNaN(odds)) {
        live.push({name, stake, odds});
        totalLiveStake += stake;
      }
    }

    // 2) Layoff inputs
    let lay = [];
    for (let j = 1; j <= layoffBetCount; j++) {
      const name   = (document.getElementById(`bet2Name-${j}`)?.value || `Layoff Bet ${j}`).trim();
      const odds   = parseFloat(document.getElementById(`odds2-${j}`)?.value);
      const target = parseFloat(document.getElementById(`setAmount-${j}`)?.value);
      if (!isNaN(odds) && odds > 1 && !isNaN(target)) {
        lay.push({name, odds, target});
      }
    }

    if (lay.length === 0) {
      out.innerHTML = '<em>Please enter at least one layoff bet (odds + target profit).</em>';
      btn.disabled = false; btn.textContent = 'Calculate Layoff Bet';
      return;
    }

    // 3) Ax=b
    const n = lay.length;
    const A = Array.from({length:n}, () => Array(n).fill(0));
    const b = Array(n).fill(0);

    for (let r = 0; r < n; r++) {
      for (let c = 0; c < n; c++) A[r][c] = (r === c) ? (lay[r].odds - 1) : -1;
      b[r] = totalLiveStake + lay[r].target;
    }

    // 4) Solve
    let stakes;
    try {
      stakes = solveLinearSystem(A, b);
    } catch (e) {
      out.innerHTML = `<span class="loss">Could not compute stakes: ${e.message}</span>`;
      btn.disabled = false; btn.textContent = 'Calculate Layoff Bet';
      return;
    }
    stakes = stakes.map(x => Math.abs(x) < 1e-7 ? 0 : x);

    // 5) Output
    let totalLayoffStake = 0;
    for (let i = 0; i < n; i++) {
      const s = stakes[i];
      totalLayoffStake += s;
      out.innerHTML += `Back <strong>${lay[i].name}</strong>: Stake <strong>${money(s)}</strong> at odds of <strong>${lay[i].odds.toFixed(2)}</strong><br/>`;
    }
    out.innerHTML += '<br/>';

    const totalOutlay = totalLiveStake + totalLayoffStake;

    for (const bLive of live) {
      const profit = bLive.stake * bLive.odds - totalOutlay;
      const cls = profit >= 0 ? 'profit' : 'loss';
      out.innerHTML += `<span class="${cls}">If ${bLive.name} wins: ${profit >= 0 ? '+' : ''}${money(profit)}</span><br/>`;
    }

    for (let i = 0; i < n; i++) {
      const profit = stakes[i] * lay[i].odds - totalOutlay;
      const cls = profit >= 0 ? 'profit' : 'loss';
      out.innerHTML += `<span class="${cls}">If ${lay[i].name} wins: ${profit >= 0 ? '+' : ''}${money(profit)}</span> (target ${money(lay[i].target)})<br/>`;
    }

    btn.disabled = false; btn.textContent = 'Calculate Layoff Bet';
  }

  function clearAllFields() {
    document.getElementById('output').innerHTML = '';
    for (let i = 1; i <= liveBetCount; i++) {
      const n = document.getElementById(`bet1Name-${i}`);    if (n) n.value = '';
      const a = document.getElementById(`bet1Amount-${i}`);  if (a) a.value = '';
      const o = document.getElementById(`odds1-${i}`);       if (o) o.value = '';
      const c = document.getElementById(`collect1-${i}`);    if (c) c.textContent = '$0.00';
    }
    for (let j = 1; j <= layoffBetCount; j++) {
      const n = document.getElementById(`bet2Name-${j}`);    if (n) n.value = '';
      const o = document.getElementById(`odds2-${j}`);       if (o) o.value = '';
      const s = document.getElementById(`setAmount-${j}`);   if (s) s.value = '';
    }
    updateRunningTotal();
  }
</script>
{% endblock %}
